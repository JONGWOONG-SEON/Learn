## chapter.12 카프카 운영하기

### 12.1 토픽 작업
- **kafka-topics.sh** 를 통해 토픽을 제어할 수 있음
- `--bootstrap-server`옵션은 필수
- ex) `kafka-topics.sh --bootstrap.server localhost:9092`
---
### 12.1.1 새 토픽 생성하기
- `--create`
  -  `--topic` : 생성 토픽 이름
  - `--replication-factor` : 클러스터 내부 필수 레플리카 갯수
  - `--partitions`: 토픽내 생성 파티션 갯수
  -   `--disable-rack-aware`: 랙 인식 할당기능 해제
---
### 12.1.2 토픽 목록 조회하기 
- `--list`: 토픽 목록 조회
- `--exclude-internal`: 내부 토픽 제외
---
### 12.1.3 토픽 상세 내역 조회하기
- `--describe` :  상세 내역 출력
  - `--topics-with-overrides`: 클러스터 기본값 재정의 토픽 보여주기
  - `--under-replicated-partitions`: 리더와 동기화 되지 않는 모든 파티션 보여줌
  - `--at-min-isr-partitions`:  ISR 최소값과 동일한 파티션을 보여줌
  - `--under-min-isr-partitions`: ISR 최소값에 미달하는 파티션을 보여줌
  - `--unavailable-partitions`: 리더가 없는 파티션을 보여줌
---
### 12.1.4 파티션 추가하기
```
운영중 토픽에 파티션을 늘려야하는 순간이 올 수 있다.
가령 단일 파티션에 토픽에 컨슈머 랙이 발생하고 있고 해당 메세지를 빠르게 소비하여 랙을 줄여야하는 상황이라면
컨슈머 그룹 내 컨슈머를 효과적으로 사용하기 위하여 토픽 파티션을 늘리는 절차를 시행해야한다.
```
-  `--alter --topic {토픽명} --partitions {가용 수}`
---
### 12.1.5 파티션 개수 줄이기
- 파티션을 삭제 하는 것 -> 저장 메세지 삭제와 동일
- 토픽 삭제 -> 재생성 절차
- 토픽 Migration 을 통한 안정성 확보
---
###  12.1.6 토픽 삭제하기
- `delete.topic.enable` : 클러스터 브로커 설정이 true 여야 토픽 삭제가 가능함
- `--delete ` : 토픽 삭제 인수
---
### 12.2 컨슈머 그룹
- `kafak-consumer-groups.sh` : 카프카 그룹 관리 쉘스크립트
- 0.11.0.* 이후 주키퍼에서 컨슈머 그룹을 관리하지 않음

### 컨슈머 그룹 명령어 인수 모음
- `--list` :  컨슈머 그룹 목록
- `--describe --group {컨슈머 그룹명}` : 지정 컨슈머 그룹 상세 성보 출력
- `--delete` :  컨슈머 그룹 삭제
- `--reset-offsets --to-current --dry-run > offset.csv` : 오프셋을 조기화 하지 않고 현재 까지 오프셋을 csv 출력
- `--from-file {csv} --excute`: 지정 csv 파일을 읽어 오프셋에 overwirte

### 토픽 설정 변경 인수 모음
- `kafk-config.sh` : 토픽설정에 사용하는 바이너리 파일
- `--alter  --entity-type topics --entity-name  {topic name}` : name , type 을 명시하여 변경
- `--min.insync.replicas` :  ISR 레플리카 최소 값 정의
- `--unclean.leader.election.enable` : 데이터 싱크가 올바르게 이뤄지지 않은 브로커를 리더로 선출 할 때 사용
- `--max.connections`: 브로커를 연결 할 수 있는 최대 연결 수 지정

### 프로듀서 설정 옵션
- 쓰기
  - `--sync` : 메세지를 동기적으로 씀
- 읽기
  - `ignore.error` : false 일 시 키 구분자가 정의되지 않으면 예외 발생
  - `parse.key` : false 키 값을 null 로 고정
  - `key.separator`: 키 밸류를 구분하는 구분자 기본은 탭

### 컨슈머 설정 옵션
- `whitelist`: 토픽 이름과 매치 되는 정규식 지정
- `blacklist`: 제외할 토픽 이름과 매치 되는 정규식 지정
- `--formatter`: 출력되는 메시지의 포맷을 지정
- `--group`: 컨슈머 그룹을 지정
- `--auto-offset-reset`: 오프셋이 없거나 유효하지 않은 경우 처리 방식을 지정
- `--enable-auto-commit`: 자동 오프셋 커밋 활성화 여부
- `--auto-commit-interval-ms`: 자동 오프셋 커밋 간격 (밀리초)
- `--max-poll-records`: 한 번에 읽을 최대 메시지 수
- `--fetch-min-bytes`: 한 번에 가져올 최소 데이터 크기 (바이트)
- `--fetch-max-wait-ms`: 컨슈머가 데이터를 기다리는 최대 시간 (밀리초)
- `--fetch-max-bytes`: 한 번에 가져올 최대 데이터 크기 (바이트)
- `--session-timeout-ms`: 컨슈머 그룹 세션 타임아웃 (밀리초)
- `--heartbeat-interval-ms`: 컨슈머가 주기적으로 보내는 heartbeat 메시지의 간격 (밀리초)
- `--partition-assignment-strategy`: 파티션 할당 전략
- `--client-id`: 컨슈머 클라이언트 ID
- `--acks`: 메시지가 전송된 후 브로커가 응답을 기다리는 방식
- `--isolation-level`: 트랜잭션 메시지의 격리 수준 설정

### 12.5.1 선호 레플리카 선출
- `kafka-leader-election.sh` : 레플리카 선출
  - `--election-type`: 브로커 상태에 따른 선호 비선호 
  - type : `PREEFERED` `UNPREFERRED` 
  - `--partition` :  지정 파티션에 레플리카 선출 (json 파일로 관리 가능)
    - `--path-to-json-file {파일.json}`

### 12.5.2 파티션 레플리카 변경하기
- 브로커간 부하 불균등 시 
- 브로커 다운으로 파티션이 불완전 복제 시
- 새 브로커에 빠른 파티션 분배 시
- 복제 팩터를 변경해주고 싶을 때
- `kafka-reassign-partitions` :  파티션 할당 쉘스크립트
- json 파일로도 지정할 수 있음
- `--topics-to-move-json-file {파일.json}
- `--broker-list {d1,d2} --generate`: json 에 정의된 토픽을 d1,d2로 이동
- `-- additional` : 재할당이 진행중 추가 해주는 옵션
- `--disable-rack-aware`: 랙 인식 기능으로 인해 실패 시 해당 옵션 false
- `--throttle` :  스로틀링 옵션
- `--verify` : 진행상황 체크 옵션

**복제팩터 변경하기**
- **재할당.json**
- {"topic":"topic1" , "partition":1} -> {"topic":"topic1" , "partition":1, "replicas":[브로커ID]}
**레플리카 재할당 취소**
- `kafka-reassign-partitions.sh` : `--cancle` 옵션을 사용해서 취소 가능

### 12.5.3 로그 세그먼트 덤프 뜨기
- `kafka-dump-log.sh` : 로그세그먼트를 조회하기 위한 용도
- `--file {destination file path} : 로그파일 위치 지정
- `--print-data-log` :  로그 내용 및 메타 정보조회

### 12.5.4 레플리카 검증
- `kafka-replica-verification.sh`: 클러스터 전체에 걸쳐 ISR이 동일한지 확인 하기 위함
- `--topic-white-list '{토픽}.*' : 토픽이라는 명칭에 레플리카 순회로 검증

### 12.6 기타 툴
- **클라이언트 ACL**
  - `kafka-acls.sh`: 클라이언트 접근제어를 위해 사용, 토픽 단위 제한, 주키퍼 TLS 파일 설정
- **경량 미러메이커**
  - `kafka-mirror-maker.sh`: 데이터 미러링용
- **테스트툴**
  - `kafka-broker-api-versions.sh` : API 버전 확인
  - `trogdor.sh` : 벤치마크 툴

### 12.7.1 클러스터 컨트롤러 이전하기
- 컨트롤러 선출은 주키퍼의 Ephemeral 노드를 사용
- 주키퍼의 /admin/controller 노드를 수동 삭제하면 강제로 컨트롤러가 변경됨

### 12.7.2 삭제될 토픽 삭제
- 카프카에서 delete topic 시도 시 삭제 작업이 완전히 수행되지 않았을 때
- 주키퍼 /admin/delete_topic/{topic} 노드를 지우면 수동 강제삭제 가능

### 12.7.3 수동으로 토픽 삭제하기
- 클러스터 내 모든 브로커 오프라인
- 주키퍼 카프카 클러스터 설정 삭제 /brokers/topics/{topic} 삭제 *자식노드 먼저 삭제
- 각 브로커 로그 디렉토리에서 해당 토픽 파티션 디렉토리를 삭제 {topic}-{int} 형식