## chapter.14 스트림 처리

### 1. 스트림 프로세싱 개요
- **데이터 스트림이란?**
    - 무한히 늘어나는 데이터 세트를 추상화 하는 것
- **이벤트 스트림이란?**
    - 비즈니스 활동 간에 액션으로 이 떄 데이터가 생성됨
- **이벤트 스트림 속성**
    - 이벤트 스트림은 순서를 가짐
    - 데이터 레코드의 불변성
        ```
        이벤트 스트림은 모든 작업 내역을 기록한다.
        한 주문에서 구매 , 구매 취소가 발생하면 
        설계에 따라 데이터베이스에선 최종 상태값이 구매 취소인 레코드만 가질 수 도 있지만
        이벤트 스트림은 주문에 관련한 모든 트랜잭션을 포함한 작업 내역이 기록된다.
        ```
    - 재생 가능
        - 과거에 발생한 이벤트 데이터를 복구 할 수 있다. 단 TCP 패킷은 재생이 불가능함
- **스트림 처리 기법**
    - **요청 응답**
        - 흔히 OLTP 패러다임으로 알려져 있으며, 이벤트기반 트랜잭션 처리를 말한다.
        - 활용 예시로는 결제 시스템
    - **배치 처리**
        - 흔히 OLAP 패러다임으로 알려져 있으며, 스케쥴링에 의해 데이터를 압착하여 처리된다.
        - 활용 예시로는 빅데이터
    - **스트림 처리**
        - 요청 응답과 비슷하지만, 다른 점으로는 논블로킹 방식으로 동작한다는 점이다.
        - 활용 예시로는 배송 추적, 스캠 방지 푸시


---

## **2. 스트림 프로세싱의 주요 개념**

### **2.1 토폴로지(Topology)**
- 입력 스트림 → 변환(연산) → 출력 스트림의 형태로 구성
- 여러 개의 프로세서를 연결하여 복잡한 데이터 변환을 수행할 수 있음
- 토폴로지는 DAG(Directed Acyclic Graph, 방향성 비순환 그래프) 형태로 구성되며, 각 노드는 데이터 변환 단계를 나타냄
- Kafka Streams의 `StreamsBuilder` API를 사용하여 정의 가능
- **예제**: 웹사이트의 클릭 이벤트를 수집하여 사용자 행동을 실시간으로 분석

### **2.2 시간(Time)**
Kafka Streams는 데이터를 처리할 때 **3가지 시간 개념**을 고려
- **이벤트 시간(Event Time)**: 이벤트가 실제로 발생한 시간
- **수집 시간(Ingestion Time)**: Kafka가 이벤트를 수집한 시간
- **처리 시간(Processing Time)**: 스트림 프로세싱 애플리케이션이 이벤트를 처리한 시간

Kafka Streams는 **타임스탬프 추출기(Timestamp Extractor)**를 사용하여 적절한 시간 기준을 설정할 수 있으며, `Grace Period`를 설정하면 **늦게 도착한 데이터를 허용하는 정책**을 적용할 수 있음
- **예제**: 신용카드 거래 승인 시, 이벤트 시간을 기준으로 이상 거래 탐지 수행

### **2.3 상태(State) 관리**
- **스트림 프로세싱 중 집계, 조인과 같은 연산을 수행할 때 상태 저장소(State Store)를 활용**
- Kafka Streams는 **RocksDB**를 사용하여 데이터 상태를 유지하고, **Kafka 체인지로그를 통해 복구 가능**
- Kafka Streams는 **상태 저장소를 내장**하고 있어 분산 환경에서도 안정적인 상태 관리가 가능
- 상태 저장소를 활용한 `windowed aggregation`을 지원하여 시간 기반 집계가 가능
- **예제**: 사용자의 과거 구매 내역을 바탕으로 추천 상품 제공

### **2.4 스트림-테이블 이중성(Stream-Table Duality)**
Kafka에서는 스트림과 테이블을 자유롭게 변환할 수 있습니다
- **KStream**: 연속적인 이벤트 스트림, 변하지 않는 이벤트 로그
- **KTable**: 최신 상태만 유지하는 테이블. 같은 키가 업데이트되면 이전 값이 대체
- **GlobalKTable**: 애플리케이션 전체에서 공유할 수 있는 테이블

Kafka Streams의 `toTable()` 메서드를 통해 **스트림을 테이블로 변환 가능**하며, `Materialized` 클래스를 사용하여 **KTable의 상태를 외부 저장소와 동기화 가능**함
- **예제**: 온라인 쇼핑몰에서 상품 리뷰 데이터를 스트림으로 수집하고, 이를 집계하여 평점 테이블을 유지

### **2.5 윈도우(Time Windows)**
Kafka Streams는 **시간 단위로 데이터를 그룹화하여 집계**할 수 있도록 다양한 윈도우 기능을 지원

- **Tumbling Window**: 고정된 간격으로 연속되지 않는 윈도우.
- **Hopping Window**: 중첩되는 윈도우 간격으로 일정 시간마다 집계 가능.
- **Sliding Window**: 이벤트 발생 시간을 기준으로 동적으로 집계.
- **Session Window**: 사용자 활동 간격을 기준으로 가변적인 윈도우 생성.

Kafka Streams의 `windowedBy()` 메서드를 사용하여 **윈도우 연산을 적용할 수 있습니다.**
- **예제**: 최근 5분 동안 가장 많이 검색된 키워드 분석

